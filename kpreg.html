<!-- =========================
  kpreg.html — Kids Party Registration Form (Netlify + Firebase)
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kids Party — Registration</title>
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --card:#fff; --muted:#64748b; --border:#e5e7eb; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(2,6,23,.04); padding: 20px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 14px; }
    .descbox { background:#f1f5f9; border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:13px; margin:10px 0 20px; line-height:1.4; }
    .grid { display:grid; gap:16px; }
    @media (min-width: 768px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:13px; font-weight:600; margin:0 0 6px; }
    input, select { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:14px; }
    .row { display:flex; gap:10px; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn:hover { background:#f8fafc; }
    .btn.primary { background:#0f172a; border-color:#0f172a; color:#fff; }
    .tag { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f8fafc; font-size:12px; }
    .kid { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fcfdff; }
    .footer { margin-top: 24px; font-size: 12px; color: var(--muted); }

    /* Banner (collapsible) */
    .banner { position:relative; overflow:hidden; border-radius:14px; border:1px solid var(--border); background:#000; transition:max-height .45s ease; margin-bottom:20px; }
    .banner img { width:100%; height:auto; display:block; }
    .banner.collapsed { max-height: var(--collapsedH, 400px); }
    .banner-gradient { position:absolute; left:0; right:0; bottom:0; height:56px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.9)); pointer-events:none; transition: opacity .25s ease; }
    .banner-toggle { position:absolute; bottom:10px; right:10px; border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.06); }
  </style>

  <!-- Firebase CDN v10 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, doc, collection as fsCollection
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === Firebase config ===
    const firebaseConfig = {
      apiKey: "AIzaSyCGr7f6BxxsOO1BJMxfdOF7wMjintKYwiY",
      authDomain: "kwlrintranet.firebaseapp.com",
      projectId: "kwlrintranet",
      storageBucket: "kwlrintranet.firebasestorage.app",
      messagingSenderId: "601132046075",
      appId: "1:601132046075:web:b840ed4a2187ab60e8825e",
      measurementId: "G-PK4MVBSJPB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Helpers ---
    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(c));
      return n;
    };

    let kids = [ { fullName:'', age:'', relationship:'' } ];

    function renderKids(){
      const box = document.getElementById('kidsBox');
      box.innerHTML = '';
      kids.forEach((k, idx) => {
        const row = el('div', { class:'kid' }, [
          el('div', { class:'row' }, [ el('span', { class:'tag', text:`Kid #${idx+1}` }) ]),
          el('div', { class:'grid grid-2' }, [
            (()=>{ const w=el('div'); w.appendChild(el('label',{text:"Kid's Full Name"}));
              const i=el('input',{placeholder:'e.g. Emma Chan', value:k.fullName});
              i.addEventListener('input', e=>{ k.fullName=e.target.value; });
              w.appendChild(i); return w; })(),
            (()=>{ const w=el('div'); w.appendChild(el('label',{text:'Age'}));
              const i=el('input',{type:'number', min:'0', max:'18', placeholder:'e.g. 8', value:k.age});
              i.addEventListener('input', e=>{ k.age=e.target.value; });
              w.appendChild(i); return w; })(),
            (()=>{ const w=el('div'); w.style.gridColumn='1 / span 2';
              w.appendChild(el('label',{text:'Relationship'}));
              const i=el('input',{placeholder:'Son / Daughter / Nephew ...', value:k.relationship});
              i.addEventListener('input', e=>{ k.relationship=e.target.value; });
              w.appendChild(i); return w; })(),
          ]),
          el('div', { class:'row' }, [
            el('button', { class:'btn', type:'button' }, [document.createTextNode('Remove')])
          ])
        ]);
        row.querySelector('button').addEventListener('click', () => {
          if (kids.length === 1) return;
          kids = kids.filter((_, i) => i !== idx);
          renderKids();
        });
        box.appendChild(row);
      });
    }

    function resetForm(){
      document.getElementById('agentName').value = '';
      document.getElementById('branch').value = '';
      document.getElementById('email').value = '';
      kids = [ { fullName:'', age:'', relationship:'' } ];
      renderKids();
      document.getElementById('saveTag').textContent = '';
    }

    async function submitForm(e){
      e.preventDefault();
      const agentName = document.getElementById('agentName').value.trim();
      const branch = document.getElementById('branch').value;
      const email = document.getElementById('email').value.trim();
      if (!agentName || !branch || !email) { alert('Please fill Agent/Branch/Email.'); return; }
      const cleanKids = kids.filter(k => k.fullName && k.age !== '' && k.relationship);
      if (cleanKids.length === 0){ alert('Please add at least one kid with all fields.'); return; }

      try {
        const subRef = await addDoc(collection(db, 'party_submissions'), {
          agentName, branch, email, createdAt: serverTimestamp()
        });
        const kidsCol = fsCollection(doc(db, 'party_submissions', subRef.id), 'kids');
        await Promise.all(cleanKids.map(k => addDoc(kidsCol, {
          fullName: k.fullName.trim(),
          age: Number(k.age),
          relationship: k.relationship.trim()
        })));
        document.getElementById('saveTag').textContent = `Saved ✓ Ref: ${subRef.id}`;
        resetForm();
      } catch(err){
        alert('Submit failed: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderKids();
      document.getElementById('addKid').addEventListener('click', () => {
        kids.push({ fullName:'', age:'', relationship:'' });
        renderKids();
      });
      document.getElementById('regForm').addEventListener('submit', submitForm);
      document.getElementById('resetBtn').addEventListener('click', resetForm);

      // Banner logic
      const bannerBox = document.getElementById('bannerBox');
      const bannerImg = document.getElementById('bannerImg');
      const bannerTog = document.getElementById('bannerToggle');
      const bannerGrad = document.getElementById('bannerGrad');

      function setCollapsedHeight(){
        const h = bannerImg.clientHeight || 0;
        const half = Math.max(200, Math.round(h/2));
        bannerBox.style.setProperty('--collapsedH', half + 'px');
      }
      function setExpandedUI(expanded){
        bannerTog.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        bannerTog.textContent = expanded ? 'Show less ▴' : 'Show more ▾';
        bannerGrad.style.opacity = expanded ? '0' : '1';
      }
      bannerImg.addEventListener('load', () => { setCollapsedHeight(); setExpandedUI(false); });
      window.addEventListener('resize', () => { if (bannerBox.classList.contains('collapsed')) setCollapsedHeight(); });
      bannerTog.addEventListener('click', () => {
        const isCollapsed = bannerBox.classList.contains('collapsed');
        if (isCollapsed){ bannerBox.classList.remove('collapsed'); setExpandedUI(true); }
        else { bannerBox.classList.add('collapsed'); setCollapsedHeight(); setExpandedUI(false); }
      });
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header style="margin: 0 0 16px;">
      <h1>Kids Party — Staff Registration</h1>
      <div class="muted">kpreg.html · Netlify + Firebase (Firestore subcollection)</div>
    </header>

    <div class="card">
      <!-- Collapsible Banner -->
      <div id="bannerBox" class="banner collapsed">
        <img id="bannerImg" src="images/KidsPartyPoster.png" alt="Kids Party Poster"/>
        <div class="banner-gradient" id="bannerGrad"></div>
        <button id="bannerToggle" class="banner-toggle" aria-expanded="false">Show more ▾</button>
      </div>

      <div class="descbox">
        Kids Party — Open only to KW Living Realty agents’ and staff’s children/grandchildren ages 12 &amp; under. Gift for every registered child. Registration through Google Forms. Each participating child must bring a non-perishable food donation of 10 lbs or more. All food donations will be donated to the Haven on the Queensway Food Bank, a Daily Bread Food Bank network.
      </div>

      <form id="regForm" class="grid">
        <div class="grid grid-2">
          <div>
            <label>Agent / Staff Full Name</label>
            <input id="agentName" placeholder="e.g. Nelson Lau" required />
          </div>
          <div>
            <label>Branch</label>
            <select id="branch" required>
              <option value="" disabled selected>Select a branch</option>
              <option>ICI</option>
              <option>Woodbine</option>
              <option>North Markham</option>
              <option>Mississauga</option>
              <option>Younge & Eglinton</option>
            </select>
          </div>
          <div style="grid-column: 1 / span 2;">
            <label>Email</label>
            <input id="email" type="email" placeholder="name@company.com" required />
          </div>
        </div>

        <div class="row" style="justify-content: space-between; margin-top: 4px;">
          <strong>Kid(s)</strong>
          <button id="addKid" type="button" class="btn">＋ Add Kid</button>
        </div>
        <div id="kidsBox" class="grid" style="gap:12px;"></div>

        <div class="row" style="gap:12px;">
          <button type="submit" class="btn primary">Submit Registration</button>
          <button type="button" id="resetBtn" class="btn">Reset</button>
          <span id="saveTag" class="tag"></span>
        </div>
      </form>
    </div>

    <div class="footer">© <span id="yr"></span> Kids Party</div>
  </div>
  <script>document.getElementById('yr').textContent = new Date().getFullYear();</script>
</body>
</html>
