<!-- ========================= 
  galareg.html — 2025 Xmas Gala Registration (Netlify + Firebase)
  - Reuses Kids Party theme
  - Firestore structure:
      gala_submissions/{submissionId}
        • agentName, branch, email, createdAt
        • guests subcollection: guests/{guestId} -> { firstName, lastName }
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025 Xmas Gala — Registration (galareg.html)</title>
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --card:#fff; --muted:#64748b; --border:#e5e7eb; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(2,6,23,.04); padding: 20px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 14px; }
    .descbox { background:#f1f5f9; border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:13px; margin:12px 0 16px; line-height:1.4; }
    .grid { display:grid; gap:16px; }
    @media (min-width: 768px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:13px; font-weight:600; margin:0 0 6px; }
    input, select { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--border); border-radius:12px; font-size:14px; }
    .row { display:flex; gap:10px; align-items:center; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn:hover { background:#f8fafc; }
    .btn.primary { background:#0f172a; border-color:#0f172a; color:#fff; }
    .tag { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f8fafc; font-size:12px; }
    .guest { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fcfdff; }
    .footer { margin-top: 24px; font-size: 12px; color: var(--muted); }

    /* Banner (collapsible) */
    .banner { position:relative; overflow:hidden; border-radius:14px; border:1px solid var(--border); background:#000; transition:max-height .45s ease; }
    .banner img { width:100%; height:auto; display:block; }
    .banner.collapsed { max-height: var(--collapsedH, 400px); }
    .banner-gradient { position:absolute; left:0; right:0; bottom:0; height:56px; background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.9)); pointer-events:none; transition: opacity .25s ease; }
    .banner-toggle { position:absolute; bottom:10px; right:10px; border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; font-size:13px; cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.06); }
  </style>

  <!-- Firebase CDN v10 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      doc,
      collection as fsCollection
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === Firebase config (same project) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCGr7f6BxxsOO1BJMxfdOF7wMjintKYwiY",
      authDomain: "kwlrintranet.firebaseapp.com",
      projectId: "kwlrintranet",
      storageBucket: "kwlrintranet.firebasestorage.app",
      messagingSenderId: "601132046075",
      appId: "1:601132046075:web:b840ed4a2187ab60e8825e",
      measurementId: "G-PK4MVBSJPB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Helper: create element
    const el = (tag, attrs={}, children=[]) => {
      const n = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'text') n.textContent = v;
        else n.setAttribute(k, v);
      });
      children.forEach(c => n.appendChild(c));
      return n;
    };

    // Guests optional — start empty and keep the section hidden until user adds one
    let guests = [];

    function renderGuests(){
      const box = document.getElementById('guestsBox');
      box.innerHTML = '';

      if (!guests.length){
        box.style.display = 'none';
        return;
      }
      box.style.display = 'grid';

      guests.forEach((g, idx) => {
        const row = el('div', { class:'guest' }, [
          el('div', { class:'row' }, [ el('span', { class:'tag', text:`Guest #${idx+1}` }) ]),
          el('div', { class:'grid grid-2' }, [
            (()=>{ const w=el('div'); w.appendChild(el('label',{text:'First Name'}));
              const i=el('input',{placeholder:'e.g. Emma', value:g.firstName || ''});
              i.addEventListener('input', e=>{ g.firstName=e.target.value; });
              w.appendChild(i); return w; })(),
            (()=>{ const w=el('div'); w.appendChild(el('label',{text:'Last Name'}));
              const i=el('input',{placeholder:'e.g. Chan', value:g.lastName || ''});
              i.addEventListener('input', e=>{ g.lastName=e.target.value; });
              w.appendChild(i); return w; })(),
          ]),
          el('div', { class:'row' }, [
            el('button', { class:'btn', type:'button' }, [document.createTextNode('Remove')])
          ])
        ]);
        row.querySelector('button').addEventListener('click', () => {
          if (guests.length === 1) { guests = []; renderGuests(); return; }
          guests = guests.filter((_, i) => i !== idx);
          renderGuests();
        });
        box.appendChild(row);
      });
    }

    function resetForm(){
      document.getElementById('agentName').value = '';
      document.getElementById('branch').value = '';
      document.getElementById('email').value = '';
      guests = [];
      renderGuests();
      document.getElementById('saveTag').textContent = '';
    }

    async function submitForm(e){
      e.preventDefault();
      const agentName = document.getElementById('agentName').value.trim();
      const branch = document.getElementById('branch').value;
      const email = document.getElementById('email').value.trim();
      if (!agentName || !branch || !email) { alert('Please fill Agent/Branch/Email.'); return; }

      // Guests optional — only keep rows with both names filled
      const cleanGuests = guests.filter(g => (g.firstName||'').trim() && (g.lastName||'').trim());

      try {
        const subRef = await addDoc(collection(db, 'gala_submissions'), {
          agentName, branch, email, createdAt: serverTimestamp()
        });

        if (cleanGuests.length) {
          const guestsCol = fsCollection(doc(db, 'gala_submissions', subRef.id), 'guests');
          await Promise.all(cleanGuests.map(g => addDoc(guestsCol, {
            firstName: g.firstName.trim(),
            lastName: g.lastName.trim()
          })));
        }

        document.getElementById('saveTag').textContent = `Saved ✓ Ref: ${subRef.id}`;
        // Hide form and show thank you
        document.getElementById('regForm').style.display = 'none';
        const thanks = document.createElement('div');
        thanks.style.marginTop = '20px';
        thanks.innerHTML = '<h2>Thank you for registering for the 2025 Xmas Gala!</h2>';
        document.querySelector('.card').appendChild(thanks);
      } catch(err){
        alert('Submit failed: ' + err.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderGuests();
      document.getElementById('addGuest').addEventListener('click', () => {
        guests.push({ firstName:'', lastName:'' });
        renderGuests();
      });
      document.getElementById('regForm').addEventListener('submit', submitForm);
      document.getElementById('resetBtn').addEventListener('click', resetForm);
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header style="margin: 0 0 16px;">
      <h1>2025 Xmas Gala — Staff Registration</h1>
    </header>

    <div class="card">
      <form id="regForm" class="grid">
        <!-- Collapsible Banner (inside the form, at top) -->
        <div id="bannerBox" class="banner collapsed">
          <img id="bannerImg" src="images/XmasGalaPoster.png" alt="Xmas Gala Poster"/>
          <div class="banner-gradient" id="bannerGrad"></div>
          <button id="bannerToggle" class="banner-toggle" aria-expanded="false" title="Show more">Show more ▾</button>
        </div>

        <!-- One-line description box -->
        <div class="descbox">
          2025 Xmas Gala — Internal registration for KW Living Realty agents and staff. Guest(s) are optional. If you plan to bring guest(s), please add each guest’s First & Last Name for name-listing and seating arrangement.
        </div>

        <div class="grid grid-2">
          <div>
            <label>Agent / Staff Full Name</label>
            <input id="agentName" placeholder="e.g. Peter Pan" required />
          </div>
          <div>
            <label>Branch</label>
            <select id="branch" required>
              <option value="" disabled selected>Select a branch</option>
              <option>ICI</option>
              <option>Woodbine</option>
              <option>North Markham</option>
              <option>Mississauga</option>
              <option>Younge & Eglinton</option>
              <option>Head Office</option>
            </select>
          </div>
          <div style="grid-column: 1 / span 2;">
            <label>Email</label>
            <input id="email" type="email" placeholder="name@company.com" required />
          </div>
        </div>

        <div class="row" style="justify-content: space-between; margin-top: 4px;">
          <strong>Guest(s) <span class="muted">(Optional)</span></strong>
          <button id="addGuest" type="button" class="btn">＋ Add Guest</button>
        </div>

        <div id="guestsBox" class="grid" style="gap:12px; display:none;"></div>

        <div class="row" style="gap:12px;">
          <button type="submit" class="btn primary">Submit Registration</button>
          <button type="button" id="resetBtn" class="btn">Reset</button>
          <span id="saveTag" class="tag"></span>
        </div>
      </form>
    </div>

    <div class="footer">© <span id="yr"></span> KW Living Realty</div>
  </div>

  <script>document.getElementById('yr').textContent = new Date().getFullYear();</script>
  <script>
    // Lightweight banner toggle (no Firebase dependency)
    (function(){
      function ready(fn){ if (document.readyState!=='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
      ready(function(){
        var bannerBox = document.getElementById('bannerBox');
        var bannerImg = document.getElementById('bannerImg');
        var bannerTog = document.getElementById('bannerToggle');
        var bannerGrad = document.getElementById('bannerGrad');
        if(!bannerBox||!bannerImg||!bannerTog) return;
        function setCollapsedHeight(){
          var h = bannerImg.clientHeight || 0;
          var half = Math.max(200, Math.round(h/2));
          bannerBox.style.setProperty('--collapsedH', half + 'px');
        }
        function setExpandedUI(expanded){
          bannerTog.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          bannerTog.textContent = expanded ? 'Show less ▴' : 'Show more ▾';
          if (bannerGrad) bannerGrad.style.opacity = expanded ? '0' : '1';
        }
        bannerImg.addEventListener('load', function(){ setCollapsedHeight(); setExpandedUI(false); });
        window.addEventListener('resize', function(){ if (bannerBox.classList.contains('collapsed')) setCollapsedHeight(); });
        bannerTog.addEventListener('click', function(e){
          e.preventDefault();
          var isCollapsed = bannerBox.classList.contains('collapsed');
          if (isCollapsed){
            bannerBox.classList.remove('collapsed');
            setExpandedUI(true);
          } else {
            bannerBox.classList.add('collapsed');
            setCollapsedHeight();
            setExpandedUI(false);
          }
        });
      });
    })();
  </script>
</body>
</html>


<!-- =========================
  galaoperations.html — 2025 Xmas Gala Submissions Viewer (Netlify + Firebase)
  - View all submissions
  - Expand to view guests (subcollection)
  - Export flattened CSV (one guest per row)
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025 Xmas Gala — Operations (galaoperations.html)</title>
  <style>
    :root { --bg:#f6f7fb; --fg:#0f172a; --card:#fff; --muted:#64748b; --border:#e5e7eb; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: 0 10px 24px rgba(2,6,23,.04); padding: 20px; }
    h1 { font-size: 22px; margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 14px; }
    .descbox { background:#f1f5f9; border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:13px; margin:12px 0 16px; line-height:1.4; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    th, td { text-align:left; border-bottom:1px solid var(--border); padding:10px; vertical-align: top; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:#fff; cursor:pointer; }
    .btn:hover { background:#f8fafc; }
    .toolbar { display:flex; gap:10px; align-items:center; justify-content: space-between; margin: 0 0 12px; }
    details { background:#fcfdff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
    .footer { margin-top: 16px; font-size:12px; color:var(--muted); }
  </style>

  <!-- Firebase CDN v10 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      orderBy,
      query,
      doc,
      collection as fsCollection
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === Firebase config (same project as galareg.html) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCGr7f6BxxsOO1BJMxfdOF7wMjintKYwiY",
      authDomain: "kwlrintranet.firebaseapp.com",
      projectId: "kwlrintranet",
      storageBucket: "kwlrintranet.firebasestorage.app",
      messagingSenderId: "601132046075",
      appId: "1:601132046075:web:b840ed4a2187ab60e8825e",
      measurementId: "G-PK4MVBSJPB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Helpers ----------
    const tbody = () => document.querySelector('#subsBody');
    const status = (msg) => document.querySelector('#status').textContent = msg || '';

    function fmtDate(ts){
      return ts?.toDate ? ts.toDate().toLocaleString() : '';
    }
    function csvCell(v){
      const s = (v ?? '').toString().replaceAll('"','""');
      return `"${s}"`;
    }

    // ---------- Load submissions ----------
    async function loadSubmissions(){
      status('Loading…');
      const qref = query(collection(db, 'gala_submissions'), orderBy('createdAt','desc'));
      const snap = await getDocs(qref);
      const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      const body = tbody();
      body.innerHTML = '';
      rows.forEach((it, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${it.agentName || ''}</td>
          <td>${it.branch || ''}</td>
          <td>${it.email || ''}</td>
          <td>${fmtDate(it.createdAt) || '—'}</td>
          <td><button class="btn" data-id="${it.id}">View</button></td>
        `;
        body.appendChild(tr);
        tr.querySelector('button').addEventListener('click', () => toggleGuests(it.id, tr));
      });

      status(rows.length ? '' : 'No submissions yet.');
    }

    // ---------- Expand/Collapse guests for a submission ----------
    async function toggleGuests(submissionId, hostTr){
      const next = hostTr.nextElementSibling;
      if (next && next.classList.contains('guests-row')) { next.remove(); return; }

      const guestsSnap = await getDocs(fsCollection(doc(db,'gala_submissions', submissionId), 'guests'));
      const guests = guestsSnap.docs.map(k => ({ id:k.id, ...k.data() }));

      const tr = document.createElement('tr'); tr.className = 'guests-row';
      const td = document.createElement('td'); td.colSpan = 6;

      const details = document.createElement('details'); details.open = true;
      const summary = document.createElement('summary'); summary.textContent = `Guest(s) — ${guests.length}`;
      details.appendChild(summary);

      if (!guests.length){
        details.appendChild(document.createTextNode('No guests found.'));
      } else {
        const tbl = document.createElement('table');
        tbl.innerHTML = `
          <thead><tr><th>First Name</th><th>Last Name</th></tr></thead>
          <tbody>
            ${guests.map(g => `<tr><td>${g.firstName || ''}</td><td>${g.lastName || ''}</td></tr>`).join('')}
          </tbody>
        `;
        details.appendChild(tbl);
      }

      td.appendChild(details);
      tr.appendChild(td);
      hostTr.after(tr);
    }

    // ---------- Export CSV (flattened: one guest per row) ----------
    async function exportCSV(){
      status('Exporting CSV…');
      const qref = query(collection(db, 'gala_submissions'), orderBy('createdAt','desc'));
      const snap = await getDocs(qref);
      const subs = snap.docs.map(d => ({ id:d.id, ...d.data() }));

      const header = [
        'SubmissionID','CreatedAt','AgentName','Branch','Email','GuestFirstName','GuestLastName'
      ];
      const lines = [header.join(',')];

      for (const s of subs){
        const guestsSnap = await getDocs(fsCollection(doc(db,'gala_submissions', s.id), 'guests'));
        const guests = guestsSnap.docs.map(g => ({ id:g.id, ...g.data() }));

        if (!guests.length){
          lines.push([
            csvCell(s.id), csvCell(fmtDate(s.createdAt)), csvCell(s.agentName), csvCell(s.branch), csvCell(s.email),
            '', ''
          ].join(','));
        } else {
          for (const g of guests){
            lines.push([
              csvCell(s.id), csvCell(fmtDate(s.createdAt)), csvCell(s.agentName), csvCell(s.branch), csvCell(s.email),
              csvCell(g.firstName), csvCell(g.lastName)
            ].join(','));
          }
        }
      }

      const blob = new Blob([lines.join('
')], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'');
      a.href = url;
      a.download = `xmas_gala_submissions_${ts}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      status(''); // clear
    }

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('refresh').addEventListener('click', loadSubmissions);
      document.getElementById('export').addEventListener('click', exportCSV);
      loadSubmissions();
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header style="margin:0 0 16px;">
      <h1>2025 Xmas Gala — Operations</h1>
      <div class="muted">View submissions and export a CSV for reporting.</div>
    </header>

    <div class="card">
      <div class="descbox">
        View all registrations submitted via the staff form. Click “View” to see each submission’s guest list. Use “Export CSV” to download a flattened spreadsheet (one guest per row).
      </div>

      <div class="toolbar">
        <div class="muted" id="status"></div>
        <div>
          <button id="refresh" class="btn">⟳ Refresh</button>
          <button id="export" class="btn">⬇︎ Export CSV</button>
        </div>
      </div>

      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Agent / Staff</th>
              <th>Branch</th>
              <th>Email</th>
              <th>Created</th>
              <th>Guests</th>
            </tr>
          </thead>
          <tbody id="subsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">© <span id="yr"></span> KW Living Realty</div>
  </div>

  <script>document.getElementById('yr').textContent = new Date().getFullYear();</script>
</body>
</html>
