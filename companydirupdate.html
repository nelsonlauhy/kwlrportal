<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Company Directory Import</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <!-- your existing Firebase config -->
  <script src="./js/firebaseConfig.js"></script>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="h4 mb-3">Company Directory Import → Firestore</h1>
    <p>
      This tool will delete all existing records in
      <code>companydirectory</code>, then re-import all rows from
      <code>ContactData</code> sheet of
      <code>commanydirectorypdf/Company Directory Data 20251103.xlsx</code>.
    </p>

    <button id="startBtn" class="btn btn-danger mb-3">
      Delete &amp; Re-Import
    </button>

    <div id="status" class="small text-muted mb-2"></div>
    <pre
      id="log"
      class="small bg-white p-2 border rounded"
      style="max-height: 320px; overflow: auto;"
    ></pre>
  </div>

  <!-- SheetJS for Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    const excelUrl = "commanydirectorypdf/Company Directory Data 20251103.xlsx";
    const startBtn = document.getElementById("startBtn");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    function log(msg) {
      logEl.textContent += msg + "\n";
    }

    function getCompanyCode(officeId) {
      switch (Number(officeId)) {
        case 1: case 2: case 3: case 4: case 5: return "KWLR";
        case 7: return "ICI";
        case 8: return "LPI HO";
        case 9: return "LPI CT";
        case 11: return "LPI EQ1";
        case 12: return "LPI EQ2";
        case 13: return "LPI AT";
        case 14: return "IHMG";
        default: return "";
      }
    }

    function getCompanyName(officeId) {
      switch (Number(officeId)) {
        case 1: case 2: case 3: case 4: case 5: case 6: case 7:
          return "KW Living Realty";
        case 8: case 9: case 10: case 11: case 12: case 13:
          return "Living Properties";
        case 14:
          return "IHMG";
        default:
          return "";
      }
    }

    async function deleteAllDocs() {
      const snapshot = await db.collection("companydirectory").get();
      if (snapshot.empty) {
        log("No existing records found.");
        return;
      }

      log(`Deleting ${snapshot.size} existing documents...`);
      const batchSize = 100;
      let deletedCount = 0;

      const docs = snapshot.docs;
      for (let i = 0; i < docs.length; i += batchSize) {
        const batch = db.batch();
        const slice = docs.slice(i, i + batchSize);
        slice.forEach((doc) => batch.delete(doc.ref));
        await batch.commit();
        deletedCount += slice.length;
        log(`Deleted ${deletedCount}/${snapshot.size}`);
      }

      log(`✅ All ${deletedCount} documents deleted.`);
    }

    async function importFromExcel() {
      log("Downloading Excel file...");
      const res = await fetch(excelUrl);
      if (!res.ok) throw new Error("Failed to fetch Excel file: HTTP " + res.status);

      const arrayBuffer = await res.arrayBuffer();
      const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: "array" });
      const sheet = workbook.Sheets["ContactData"];
      if (!sheet) throw new Error("Worksheet 'ContactData' not found.");
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
      if (!rows.length) throw new Error("No data rows found in ContactData.");

      log(`Found ${rows.length} rows, uploading to Firestore...`);
      let successCount = 0;

      for (let i = 0; i < rows.length; i++) {
        const r = rows[i];
        const officeId = Number(r.Officeid || r.OfficeId || 0);
        const docData = {
          DisplayOrder: r.DisplayOrder || "",
          ContactType: r.ContactType || "",
          DirectTel: r.DirectTel || "",
          DisplayName: r.DisplayName || "",
          Email: r.Email || "",
          Ext: r.Ext || "",
          OfficeName: r.OfficeName || "",
          PersonalTel: r.PersonalTel || "",
          Title: r.Title || "",
          AgentList: r.AgentList || "",
          companyCode: getCompanyCode(officeId),
          Company: getCompanyName(officeId)
        };
        await db.collection("companydirectory").add(docData);
        successCount++;
        if (successCount % 10 === 0)
          statusEl.textContent = `Uploaded ${successCount} / ${rows.length}...`;
      }

      log(`✅ Uploaded ${successCount} new records.`);
      statusEl.textContent = `Import complete: ${successCount} records added.`;
    }

    startBtn.addEventListener("click", async () => {
      if (!confirm("This will DELETE all existing records in Firestore 'companydirectory'. Continue?")) return;
      startBtn.disabled = true;
      logEl.textContent = "";
      statusEl.textContent = "Starting...";

      try {
        await deleteAllDocs();
        await importFromExcel();
        statusEl.textContent = "✅ All done!";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "❌ Error: " + err.message;
        log("Error: " + err.message);
      } finally {
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
